<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>EVAC//SYS â€” Smart Emergency Evacuation Planner</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --bg:#06080f; --panel:#0d1220; --card:#111827;
  --border:rgba(0,212,255,.10);
  --green:#00ff88; --green-dim:rgba(0,255,136,.13);
  --cyan:#00d4ff; --red:#ff3b30; --amber:#ffb800;
  --text:#e8f4ff; --muted:#7a9bbf; --dim:#2a3f55;
  --sb-w:240px;
  --font-hud:'Orbitron',monospace;
  --font-mono:'Space Mono',monospace;
  --font-body:'Outfit',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font-body);font-size:13px;overflow:hidden;-webkit-font-smoothing:antialiased;}
button,select,input{font-family:inherit;cursor:pointer;}

/* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#loading{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;transition:opacity .5s,visibility .5s;}
#loading.gone{opacity:0;visibility:hidden;pointer-events:none;}
.ld-logo{font-family:var(--font-hud);font-size:32px;font-weight:900;letter-spacing:.15em;color:var(--green);animation:glow-anim 1.4s ease-in-out infinite;}
.ld-sub{font-family:var(--font-mono);font-size:10px;color:var(--muted);letter-spacing:.25em;text-transform:uppercase;}
.ld-bar{width:260px;height:2px;background:var(--card);border-radius:2px;overflow:hidden;}
.ld-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--cyan));animation:load-fill 1.4s ease-out forwards;}
@keyframes load-fill{from{width:0}to{width:100%}}
@keyframes glow-anim{0%,100%{text-shadow:0 0 30px rgba(0,255,136,.5)}50%{text-shadow:0 0 70px rgba(0,255,136,.9),0 0 120px rgba(0,255,136,.3)}}

/* â”€â”€ SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:grid;grid-template-rows:52px 1fr;grid-template-columns:var(--sb-w) 1fr 300px;height:100vh;opacity:0;transition:opacity .5s;}
#app.on{opacity:1;}
/* sidebar collapsed â†’ shrink column */
#app.sb-closed{grid-template-columns:0px 1fr 300px;}

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#topbar{grid-column:1/-1;display:flex;align-items:center;gap:10px;padding:0 14px;background:var(--panel);border-bottom:1px solid var(--border);z-index:20;}
.t-logo{font-family:var(--font-hud);font-size:13px;font-weight:900;letter-spacing:.12em;color:var(--green);white-space:nowrap;text-shadow:0 0 14px rgba(0,255,136,.4);}
.t-logo span{color:var(--dim);font-weight:400;}
.t-sep{width:1px;height:26px;background:var(--border);flex-shrink:0;}
.t-spacer{flex:1;}

/* hamburger */
#btn-sb-toggle{
  display:flex;flex-direction:column;justify-content:center;align-items:center;gap:4px;
  width:34px;height:34px;background:var(--card);border:1px solid var(--border);border-radius:5px;
  flex-shrink:0;transition:all .2s;
}
#btn-sb-toggle:hover{border-color:var(--cyan);background:rgba(0,212,255,.07);}
#btn-sb-toggle .bar{width:16px;height:2px;background:var(--cyan);border-radius:2px;transition:all .3s cubic-bezier(.4,0,.2,1);}
/* animate to X when open */
#btn-sb-toggle.open .bar:nth-child(1){transform:translateY(6px) rotate(45deg);}
#btn-sb-toggle.open .bar:nth-child(2){opacity:0;transform:scaleX(0);}
#btn-sb-toggle.open .bar:nth-child(3){transform:translateY(-6px) rotate(-45deg);}

.preset-row{display:flex;gap:5px;align-items:center;}
.preset-lbl{font-family:var(--font-mono);font-size:9px;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;white-space:nowrap;}
.btn-preset{padding:3px 9px;font-size:9px;background:var(--card);border:1px solid var(--border);color:var(--muted);border-radius:3px;font-family:var(--font-mono);letter-spacing:.04em;text-transform:uppercase;transition:all .15s;white-space:nowrap;}
.btn-preset:hover{border-color:var(--amber);color:var(--amber);}
.status-pill{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:4px 12px;min-width:190px;}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:pulse-dot 1.5s ease-in-out infinite;flex-shrink:0;}
@keyframes pulse-dot{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.6);opacity:.6}}
.stxt{font-family:var(--font-mono);font-size:10px;letter-spacing:.07em;text-transform:uppercase;}
.stxt.safe{color:var(--green)}.stxt.danger{color:var(--red);animation:blink-anim .8s step-end infinite}.stxt.clear{color:var(--cyan)}
@keyframes blink-anim{50%{opacity:.3}}
.timer-wrap{display:flex;align-items:center;gap:7px;background:var(--card);border:1px solid var(--border);border-radius:6px;padding:3px 10px;}
.timer-lbl{font-family:var(--font-mono);font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em;}
.timer-val{font-family:var(--font-hud);font-size:17px;font-weight:700;color:var(--cyan);letter-spacing:.04em;min-width:52px;}
.timer-val.warn{color:var(--amber)}.timer-val.crit{color:var(--red);animation:blink-anim .5s step-end infinite}
.btn-t{padding:3px 7px;font-size:9px;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:3px;font-family:var(--font-mono);transition:all .15s;}
.btn-t:hover{border-color:var(--cyan);color:var(--cyan);}
.btn-top{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:4px;font-size:10px;font-family:var(--font-mono);letter-spacing:.04em;text-transform:uppercase;border:1px solid;transition:all .15s;white-space:nowrap;}
.btn-builder{background:rgba(0,212,255,.07);border-color:rgba(0,212,255,.3);color:var(--cyan);}
.btn-builder:hover{background:rgba(0,212,255,.18);}
.btn-reset{background:rgba(255,59,48,.07);border-color:rgba(255,59,48,.3);color:var(--red);}
.btn-reset:hover{background:rgba(255,59,48,.18);}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar{
  background:var(--panel);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
  width:var(--sb-w);
  transition:width .35s cubic-bezier(.4,0,.2,1), opacity .3s;
  will-change:width;
}
#sidebar.closed{width:0;opacity:0;border-right:none;}
.sb-sec{padding:12px;border-bottom:1px solid var(--border);flex-shrink:0;}
.sb-title{font-family:var(--font-hud);font-size:8px;font-weight:700;color:var(--dim);letter-spacing:.2em;text-transform:uppercase;margin-bottom:9px;display:flex;align-items:center;gap:6px;white-space:nowrap;}
.sb-title::before{content:'';display:block;width:3px;height:11px;background:var(--green);border-radius:2px;flex-shrink:0;}
.ctrl-lbl{font-size:10px;color:var(--muted);font-family:var(--font-mono);margin-bottom:4px;display:block;white-space:nowrap;}
select{width:100%;padding:6px 10px;background:var(--card);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%237a9bbf'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 9px center;padding-right:26px;transition:all .15s;}
select:focus{border-color:var(--green);}
.legend{display:flex;flex-direction:column;gap:5px;}
.leg-row{display:flex;align-items:center;gap:8px;font-size:10px;color:var(--muted);white-space:nowrap;}
.leg-dot{width:11px;height:11px;border-radius:3px;flex-shrink:0;}
.lg-start{background:rgba(0,212,255,.25);border:1.5px solid var(--cyan);}
.lg-path{background:rgba(0,255,136,.2);border:1.5px solid var(--green);}
.lg-exit{background:rgba(0,255,136,.08);border:1.5px solid #00cc66;}
.lg-hazard{background:rgba(255,59,48,.2);border:1.5px solid var(--red);}
.lg-stair{background:rgba(255,184,0,.15);border:1.5px solid var(--amber);}
.lg-normal{background:var(--card);border:1.5px solid var(--border);}
#node-list{flex:1;overflow-y:auto;padding:6px;}
#node-list::-webkit-scrollbar{width:3px;}
#node-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.nl-floor{font-family:var(--font-mono);font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.12em;padding:5px 6px 3px;border-bottom:1px solid var(--border);margin-bottom:3px;margin-top:4px;white-space:nowrap;}
.nl-item{display:flex;align-items:center;gap:7px;padding:4px 8px;border-radius:3px;cursor:pointer;border:1px solid transparent;transition:all .12s;white-space:nowrap;}
.nl-item:hover{background:rgba(255,255,255,.04);border-color:var(--border);}
.nl-item.haz{background:rgba(255,59,48,.05);border-color:rgba(255,59,48,.2);}
.nl-item.exit-node{border-color:rgba(0,255,136,.12);}
.nl-item.start-node{border-color:rgba(0,212,255,.25);}
.nl-icon{font-size:11px;flex-shrink:0;}
.nl-name{flex:1;font-size:11px;overflow:hidden;text-overflow:ellipsis;}
.nl-hbadge{font-size:11px;}

/* â”€â”€ MAIN MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{background:var(--bg);overflow:hidden;display:flex;flex-direction:column;position:relative;}

/* Animated background canvas â€” fills whole main area */
#bg-canvas{position:absolute;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;}

.map-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 14px;border-bottom:1px solid var(--border);
  flex-shrink:0;position:relative;z-index:3;
  background:rgba(13,18,32,.75);backdrop-filter:blur(6px);
}
.map-title{font-family:var(--font-hud);font-size:9px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;}
.zoom-info{font-family:var(--font-mono);font-size:9px;color:var(--cyan);opacity:.75;}

/* scroll container â€” overflow so panned/zoomed SVG can show */
#map-scroll{
  flex:1;overflow:auto;
  display:flex;align-items:center;justify-content:center;
  position:relative;z-index:1;
  cursor:default;
}
#map-scroll::-webkit-scrollbar{width:4px;height:4px;}
#map-scroll::-webkit-scrollbar-thumb{background:rgba(0,212,255,.15);border-radius:2px;}

/* The actual SVG lives inside this wrapper â€” we scale IT */
#svg-pan-wrap{
  display:inline-block;
  transform-origin:center center;
  transition:transform .6s cubic-bezier(.22,1,.36,1);
  will-change:transform;
}

/* Double-click ripple on floor */
@keyframes floor-ripple{
  0%{stroke-dashoffset:0;opacity:1;}
  100%{stroke-dashoffset:-300;opacity:0;}
}
.floor-ripple-ring{
  fill:none;stroke:rgba(0,212,255,.8);stroke-width:3;
  stroke-dasharray:20 10;
  animation:floor-ripple .8s ease-out forwards;
  pointer-events:none;
}

/* â”€â”€ SVG NODE STYLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.floor-rect{fill:rgba(10,16,36,.82);stroke-width:1.5;}
.floor-rect.b1{stroke:rgba(255,184,0,.45);}
.floor-rect.gf{stroke:rgba(0,212,255,.5);}
.floor-rect.f1,.floor-rect.f2,.floor-rect.f3{stroke:rgba(0,212,255,.28);}

.floor-label{
  font-family:'Orbitron',monospace;font-size:11px;font-weight:700;
  fill:rgba(0,212,255,.55);letter-spacing:.16em;text-transform:uppercase;
  pointer-events:none;
}
.floor-hit{fill:transparent;cursor:pointer;}

/* active floor zoom ring â€” pulsing */
@keyframes ring-pulse{
  0%,100%{stroke-opacity:.6;stroke-width:3;}
  50%{stroke-opacity:1;stroke-width:4.5;}
}
.floor-zoom-ring{
  fill:none;stroke:var(--cyan);stroke-width:3;rx:13;
  pointer-events:none;
  animation:ring-pulse 1.8s ease-in-out infinite;
}

.edge{stroke:rgba(0,212,255,.18);stroke-width:1.5;fill:none;}
.edge.on-path{stroke:#00ff88;stroke-width:3;filter:drop-shadow(0 0 5px rgba(0,255,136,.6));}
.edge.cross{stroke:rgba(255,184,0,.3);stroke-dasharray:7 3;}
.edge.cross.on-path{stroke:#00ff88;stroke-dasharray:none;}

.node-g{cursor:pointer;}
.node-rect{fill:#111827;stroke:rgba(0,212,255,.2);stroke-width:1.5;transition:fill .15s,stroke .15s;}
.node-g:hover .node-rect{stroke:var(--cyan);fill:rgba(0,212,255,.09);filter:drop-shadow(0 0 8px rgba(0,212,255,.3));}
.node-lbl{font-family:'Outfit',sans-serif;font-size:11px;font-weight:500;fill:#c8ddf0;text-anchor:middle;dominant-baseline:middle;pointer-events:none;}

.node-g.s-start .node-rect{fill:rgba(0,212,255,.13);stroke:var(--cyan);stroke-width:2;filter:drop-shadow(0 0 9px rgba(0,212,255,.45));}
.node-g.s-exit  .node-rect{fill:rgba(0,255,136,.07);stroke:#00cc66;}
.node-g.s-path  .node-rect{fill:rgba(0,255,136,.19);stroke:#00ff88;stroke-width:2.5;filter:drop-shadow(0 0 11px rgba(0,255,136,.5));animation:pop-in .3s ease both;}
.node-g.s-hazard .node-rect{fill:rgba(255,59,48,.16);stroke:#ff3b30;stroke-width:2;animation:shk .25s ease;}
.node-g.s-exit-blocked .node-rect{fill:rgba(255,59,48,.16);stroke:#ff3b30;stroke-width:2;}
.node-g.s-stair .node-rect{stroke:rgba(255,184,0,.45);}
.node-g.s-start .node-lbl{fill:var(--cyan);}
.node-g.s-exit  .node-lbl{fill:#00cc66;}
.node-g.s-path  .node-lbl{fill:#00ff88;}
.node-g.s-hazard .node-lbl{fill:#ff3b30;}

@keyframes pop-in{from{opacity:0;transform:scale(.93)}to{opacity:1;transform:scale(1)}}
@keyframes shk{0%,100%{transform:translateX(0)}25%{transform:translateX(-3px)}75%{transform:translateX(3px)}}

.badge-bg-start{fill:var(--cyan);}
.badge-bg-exit{fill:#00cc66;}
.badge-txt{font-family:'Orbitron',monospace;font-size:7px;font-weight:700;fill:#06080f;text-anchor:middle;dominant-baseline:middle;pointer-events:none;}
.step-c{fill:#00ff88;}
.step-n{font-family:'Orbitron',monospace;font-size:8px;font-weight:700;fill:#06080f;text-anchor:middle;dominant-baseline:middle;pointer-events:none;}
.haz-emoji{font-size:13px;dominant-baseline:middle;text-anchor:middle;pointer-events:none;}

/* â”€â”€ RIGHT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#right{background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;padding:10px;font-family:var(--font-mono);font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);background:transparent;border:none;border-bottom:2px solid transparent;transition:all .15s;}
.tab.on{color:var(--green);border-bottom-color:var(--green);}
.tab:hover:not(.on){color:var(--muted);}
.tab-body{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.pane{display:none;flex:1;flex-direction:column;overflow:hidden;}
.pane.on{display:flex;}
#route-pane{overflow-y:auto;padding:14px;flex:1;}
#route-pane::-webkit-scrollbar{width:3px;}
#route-pane::-webkit-scrollbar-thumb{background:var(--border);}
.r-idle{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;height:100%;text-align:center;color:var(--muted);padding:20px;}
.r-idle-icon{font-size:36px;opacity:.35;}
.r-idle-sub{font-size:10px;color:var(--dim);}
.r-fail{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;height:100%;text-align:center;padding:20px;}
.r-fail-icon{font-size:44px;}
.r-fail-title{font-family:var(--font-hud);font-size:17px;font-weight:900;color:var(--red);letter-spacing:.1em;animation:blink-anim .8s step-end infinite;}
.r-fail-sub{font-size:11px;color:var(--muted);line-height:1.6;}
.r-badge{display:inline-flex;align-items:center;font-family:var(--font-hud);font-size:9px;font-weight:700;color:var(--green);letter-spacing:.1em;background:var(--green-dim);border:1px solid rgba(0,255,136,.3);padding:3px 10px;border-radius:20px;}
.r-meta{font-size:11px;color:var(--muted);margin-top:4px;}
.r-meta strong{color:var(--green);}
.r-steps{margin-top:10px;display:flex;flex-direction:column;}
.r-step{display:flex;align-items:center;gap:8px;padding:7px 8px;border-radius:3px;position:relative;animation:step-in .25s ease both;}
.r-step:hover{background:rgba(255,255,255,.03);}
@keyframes step-in{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.r-step-connector{position:absolute;left:18px;bottom:-6px;width:2px;height:12px;background:linear-gradient(to bottom,var(--green),transparent);}
.r-step-icon{font-size:13px;width:20px;text-align:center;flex-shrink:0;}
.r-step-label{flex:1;font-size:11px;}
.r-step-floor{font-family:var(--font-mono);font-size:8px;color:var(--dim);}
.r-step-exit .r-step-label{color:var(--green);font-weight:600;}
.alt-block{border-top:1px solid var(--border);margin-top:12px;padding-top:10px;}
.alt-title{font-family:var(--font-mono);font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px;}
.alt-row{display:flex;align-items:flex-start;gap:7px;padding:5px 7px;background:var(--card);border-radius:3px;border:1px solid var(--border);font-size:10px;margin-bottom:4px;}
.alt-n{width:15px;height:15px;background:rgba(255,255,255,.05);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--font-mono);font-size:8px;color:var(--dim);flex-shrink:0;}
.alt-path{flex:1;color:var(--muted);line-height:1.4;}
.alt-exit{color:var(--green);font-family:var(--font-mono);white-space:nowrap;}
#audit-log{flex:1;overflow-y:auto;padding:8px;display:flex;flex-direction:column;gap:2px;}
#audit-log::-webkit-scrollbar{width:3px;}
#audit-log::-webkit-scrollbar-thumb{background:var(--border);}
.alog{display:flex;gap:7px;padding:4px 7px;border-radius:3px;font-size:10px;animation:step-in .2s ease;}
.alog-t{font-family:var(--font-mono);font-size:8px;color:var(--dim);flex-shrink:0;min-width:50px;}
.alog-m{flex:1;line-height:1.4;}
.alog.ok{background:rgba(0,255,136,.03);}.alog.ok .alog-m{color:#00cc6a;}
.alog.warn{background:rgba(255,184,0,.03);}.alog.warn .alog-m{color:var(--amber);}
.alog.info .alog-m{color:var(--muted);}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toasts{position:fixed;bottom:18px;right:18px;display:flex;flex-direction:column;gap:6px;z-index:8000;pointer-events:none;}
.toast{padding:8px 14px;border-radius:6px;font-size:11px;font-family:var(--font-mono);border:1px solid;transform:translateX(120%);transition:transform .3s cubic-bezier(.4,0,.2,1);pointer-events:auto;}
.toast.show{transform:translateX(0);}
.toast.ok{background:rgba(0,255,136,.1);border-color:#00cc6a;color:var(--green);}
.toast.err{background:rgba(255,59,48,.1);border-color:var(--red);color:var(--red);}
.toast.info{background:rgba(0,212,255,.1);border-color:var(--cyan);color:var(--cyan);}
.toast.warn{background:rgba(255,184,0,.1);border-color:var(--amber);color:var(--amber);}

/* â”€â”€ BUILDER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#builder-modal{display:none;position:fixed;inset:0;z-index:100;background:rgba(6,8,16,.92);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
#builder-modal.on{display:flex;}
.bw{background:var(--panel);border:1px solid rgba(0,212,255,.2);border-radius:12px;width:90vw;max-width:960px;height:78vh;display:flex;flex-direction:column;box-shadow:0 0 60px rgba(0,212,255,.08);overflow:hidden;}
.bw-head{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);}
.bw-title{font-family:var(--font-hud);font-size:11px;font-weight:700;color:var(--cyan);letter-spacing:.15em;}
.bw-body{display:grid;grid-template-columns:200px 1fr;flex:1;overflow:hidden;}
.bw-sb{padding:12px;border-right:1px solid var(--border);display:flex;flex-direction:column;gap:12px;overflow-y:auto;}
.bw-sb-title{font-family:var(--font-mono);font-size:8px;color:var(--dim);text-transform:uppercase;letter-spacing:.15em;}
.bw-canvas-wrap{background:var(--bg);position:relative;overflow:hidden;}
#bcanvas{width:100%;height:100%;}
.bw-foot{padding:8px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;}
#b-result{flex:1;font-family:var(--font-mono);font-size:10px;}
.b-hint{color:var(--dim);}.b-ok{color:var(--green);}.b-fail{color:var(--red);}
.inp{width:100%;padding:6px 9px;background:var(--card);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:11px;outline:none;}
.inp:focus{border-color:var(--green);}
.bw-hint{font-size:10px;color:var(--dim);line-height:1.7;}
.bw-hint strong{color:var(--muted);}
.btn-sm{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:3px;font-size:10px;font-family:var(--font-mono);letter-spacing:.04em;text-transform:uppercase;border:1px solid;transition:all .15s;}
.btn-danger{background:rgba(255,59,48,.07);border-color:rgba(255,59,48,.3);color:var(--red);}
.btn-danger:hover{background:rgba(255,59,48,.18);}
.btn-sec{background:var(--card);border-color:var(--border);color:var(--muted);}
.btn-sec:hover{border-color:var(--cyan);color:var(--cyan);}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading">
  <div class="ld-logo">EVAC//SYS</div>
  <div class="ld-sub">Initialising Emergency Operations Module</div>
  <div class="ld-bar"><div class="ld-fill"></div></div>
</div>

<!-- APP -->
<div id="app">

  <!-- TOPBAR -->
  <header id="topbar">
    <!-- Hamburger -->
    <button id="btn-sb-toggle" class="open" title="Toggle sidebar">
      <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>

    <div class="t-logo">EVAC<span>//</span>SYS</div>
    <div class="t-sep"></div>

    <div class="preset-row">
      <span class="preset-lbl">Presets:</span>
      <button class="btn-preset" data-preset="Ground Floor Fire">ğŸ”¥ GF Fire</button>
      <button class="btn-preset" data-preset="Exit A Blocked">ğŸš« Exit A</button>
      <button class="btn-preset" data-preset="Stairwell Fire">ğŸ”¥ Stairs</button>
      <button class="btn-preset" data-preset="Smoke on F2">ğŸ’¨ F2 Smoke</button>
      <button class="btn-preset" data-preset="Full Lockdown">â˜  Lockdown</button>
    </div>
    <div class="t-sep"></div>

    <div class="status-pill"><div class="sdot"></div><span class="stxt clear" id="status-text">SYSTEM READY</span></div>
    <div class="t-spacer"></div>

    <div class="timer-wrap">
      <span class="timer-lbl">Elapsed</span>
      <span class="timer-val" id="timer-val">00:00</span>
      <button class="btn-t" id="btn-timer">â–¶ Start</button>
      <button class="btn-t" id="btn-timer-r">â†º</button>
    </div>
    <button class="btn-top btn-builder" id="btn-builder-open">ğŸ— Builder</button>
    <button class="btn-top btn-reset" onclick="resetAll()">â†º Reset</button>
  </header>

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sb-sec">
      <div class="sb-title">Hazard Controls</div>
      <label class="ctrl-lbl">Hazard Type</label>
      <select id="hazard-type">
        <option value="fire">ğŸ”¥ Fire</option>
        <option value="smoke">ğŸ’¨ Smoke</option>
        <option value="closed">ğŸ”’ Closed</option>
        <option value="exit_blocked">ğŸš« Exit Blocked</option>
      </select>
    </div>
    <div class="sb-sec">
      <div class="sb-title">Legend</div>
      <div class="legend">
        <div class="leg-row"><div class="leg-dot lg-start"></div>Control Room (Start)</div>
        <div class="leg-row"><div class="leg-dot lg-path"></div>Evacuation Path</div>
        <div class="leg-row"><div class="leg-dot lg-exit"></div>Exit</div>
        <div class="leg-row"><div class="leg-dot lg-hazard"></div>Hazard (blocked)</div>
        <div class="leg-row"><div class="leg-dot lg-stair"></div>Stairwell</div>
        <div class="leg-row"><div class="leg-dot lg-normal"></div>Clear Room</div>
      </div>
    </div>
    <div class="sb-sec" style="padding-bottom:6px"><div class="sb-title">All Rooms</div></div>
    <div id="node-list"></div>
  </aside>

  <!-- MAIN MAP -->
  <main id="main">
    <canvas id="bg-canvas"></canvas>
    <div class="map-header">
      <div class="map-title">ğŸ“ Building Layout Â· <span style="color:rgba(0,212,255,.5)">Double-click a floor to zoom Â· Double-click again to zoom out</span></div>
      <span class="zoom-info" id="zoom-info">Overview</span>
    </div>
    <div id="map-scroll">
      <div id="svg-pan-wrap"></div>
    </div>
  </main>

  <!-- RIGHT PANEL -->
  <aside id="right">
    <div class="tabs">
      <button class="tab on" onclick="switchTab('route',this)">Route</button>
      <button class="tab" onclick="switchTab('log',this)">Audit Log</button>
    </div>
    <div class="tab-body">
      <div class="pane on" id="pane-route"><div id="route-pane"></div></div>
      <div class="pane" id="pane-log"><div id="audit-log"></div></div>
    </div>
  </aside>
</div>

<!-- BUILDER MODAL -->
<div id="builder-modal">
  <div class="bw">
    <div class="bw-head">
      <div class="bw-title">ğŸ— DYNAMIC BUILDING CREATOR</div>
      <button class="btn-sm btn-sec" id="btn-builder-close">âœ• Close</button>
    </div>
    <div class="bw-body">
      <div class="bw-sb">
        <div class="bw-sb-title">Mode</div>
        <select id="b-mode"><option value="add">â• Add Node</option><option value="link">ğŸ”— Link Nodes</option><option value="del">ğŸ—‘ Delete Node</option></select>
        <div class="bw-sb-title">Node Label</div>
        <input class="inp" id="b-label" type="text" placeholder="e.g. Conference Room"/>
        <div class="bw-sb-title">Node Type</div>
        <select id="b-type"><option value="room">Room</option><option value="corridor">Corridor</option><option value="stair">Stairwell</option><option value="exit">Exit</option><option value="control">Control (Start)</option></select>
        <div class="bw-hint" style="margin-top:4px">1. <strong>Add Node</strong> â†’ click canvas.<br><br>2. <strong>Link Nodes</strong> â†’ click two nodes.<br><br>3. Add <strong>Control</strong> + <strong>Exit</strong> for BFS path.</div>
        <button class="btn-sm btn-danger" onclick="initBuilder()">ğŸ—‘ Clear Canvas</button>
      </div>
      <div class="bw-canvas-wrap"><svg id="bcanvas"></svg></div>
    </div>
    <div class="bw-foot">
      <span style="font-family:var(--font-mono);font-size:8px;color:var(--dim)">BFS RESULT:</span>
      <div id="b-result"><span class="b-hint">Add Control + Exit nodes to compute path.</span></div>
    </div>
  </div>
</div>

<div id="toasts"></div>

<script src="buildingGraph.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const state = {
  hazardNodes: new Set(),
  hazardEdges: new Set(),
  hazardTypes: {},
  selectedHazard: 'fire',
  currentPath: null,
  evacuationFailed: false,
  timerRunning: false,
  timerSeconds: 0,
  timerInterval: null,
  builder: { nodes:{}, edges:[], linkSource:null },
  zoomedFloor: null,   // currently zoomed floor id ('b1','gf','f1','f2','f3') or null
  sidebarOpen: true,
};

function edgeKey(a,b){ return [a,b].sort().join('::'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BFS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function bfs(adj, exits, start, bN, bE){
  if(bN.has(start)) return null;
  const q = [[start]], v = new Set([start]);
  while(q.length){
    const p = q.shift(), c = p[p.length-1];
    if(exits.has(c)) return p;
    for(const nb of (adj[c]||[])){
      if(v.has(nb)||bN.has(nb)||bE.has(edgeKey(c,nb))) continue;
      v.add(nb); q.push([...p, nb]);
    }
  }
  return null;
}
function findAlts(n=3){
  const ps=[],used=new Set();
  const opt=bfs(ADJACENCY,EXITS,START_NODE,state.hazardNodes,state.hazardEdges);
  if(!opt) return [];
  ps.push(opt); used.add(opt.join('->'));
  for(let i=1;i<n;i++){
    const prev=ps[i-1]; let f=false;
    for(let j=1;j<prev.length-1;j++){
      const ex=new Set([...state.hazardNodes,prev[j]]);
      const alt=bfs(ADJACENCY,EXITS,START_NODE,ex,state.hazardEdges);
      if(alt&&!used.has(alt.join('->'))) { ps.push(alt); used.add(alt.join('->')); f=true; break; }
    }
    if(!f) break;
  }
  return ps;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HAZARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyHazard(id,t){ state.hazardNodes.add(id); state.hazardTypes[id]=t; logAudit('âš  Hazard: '+(NODES[id]?.label||id)+' ['+t.toUpperCase()+']','warn'); _recalc(); renderMap(); renderNodeList(); }
function removeHazard(id){ const t=state.hazardTypes[id]; state.hazardNodes.delete(id); delete state.hazardTypes[id]; logAudit('âœ“ Cleared: '+(NODES[id]?.label||id)+(t?' ['+t.toUpperCase()+']':''),'ok'); _recalc(); renderMap(); renderNodeList(); }
function toggleHazard(id){ if(id===START_NODE){ showToast('Cannot block the start node.','err'); return; } state.hazardNodes.has(id)?removeHazard(id):applyHazard(id,state.selectedHazard); }
function resetAll(){ state.hazardNodes.clear(); state.hazardEdges.clear(); state.hazardTypes={}; stopTimer(); state.timerSeconds=0; updateTimer(); logAudit('ğŸ”„ Reset â€” all hazards cleared','info'); _recalc(); renderMap(); renderNodeList(); showToast('Scenario reset','ok'); }
function applyPreset(name){
  const p=HAZARD_PRESETS[name]; if(!p) return;
  state.hazardNodes.clear(); state.hazardEdges.clear(); state.hazardTypes={};
  p.nodes.forEach(n=>{ state.hazardNodes.add(n); state.hazardTypes[n]='fire'; });
  (p.edges||[]).forEach(([a,b])=>state.hazardEdges.add(edgeKey(a,b)));
  logAudit('ğŸ“‹ Preset: "'+name+'" â€” '+p.description,'info');
  _recalc(); renderMap(); renderNodeList(); showToast('Preset: '+name,'info');
}
function _recalc(){ const p=bfs(ADJACENCY,EXITS,START_NODE,state.hazardNodes,state.hazardEdges); state.currentPath=p; state.evacuationFailed=!p; renderRoutePanel(); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SVG MAP DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ND = {
  Parking:       {x:451, y:365,w:85, h:45,l:'Parking'},
  Electrical:    {x:195, y:510,w:140,h:45,l:'Electrical Room'},
  Generator:     {x:366, y:510,w:102,h:45,l:'Generator'},
  EmergencyExit: {x:536, y:510,w:139,h:45,l:'Emergency Exit'},
  StairB:        {x:729, y:510,w:147,h:45,l:'Stairs B'},
  Entrance:      {x:1357,y:55, w:130,h:45,l:'Main Entrance'},
  Reception:     {x:1357,y:150,w:101,h:45,l:'Reception'},
  Hall:          {x:1357,y:245,w:97, h:45,l:'Main Hall'},
  Control:       {x:970, y:365,w:125,h:45,l:'Control Room'},
  KitchenG:      {x:1125,y:365,w:85, h:45,l:'Kitchen'},
  WashG:         {x:1269,y:365,w:105,h:45,l:'Washroom'},
  StairG:        {x:1419,y:365,w:96, h:45,l:'Stairs GF'},
  ExitA:         {x:1554,y:365,w:74, h:45,l:'Exit A'},
  ExitB:         {x:1676,y:365,w:73, h:45,l:'Exit B'},
  Lobby1:        {x:2333,y:365,w:86, h:45,l:'Lobby 1'},
  R101:          {x:1977,y:510,w:99, h:45,l:'Room 101'},
  R102:          {x:2125,y:510,w:99, h:45,l:'Room 102'},
  Office:        {x:2261,y:510,w:73, h:45,l:'Office'},
  Wash1:         {x:2405,y:510,w:117,h:45,l:'Washroom 1'},
  Stair1:        {x:2561,y:510,w:95, h:45,l:'Stairs F1'},
  Storage:       {x:2702,y:510,w:87, h:45,l:'Storage'},
  Lobby2:        {x:1390,y:510,w:86, h:45,l:'Lobby 2'},
  R201:          {x:1024,y:655,w:99, h:45,l:'Room 201'},
  R202:          {x:1173,y:655,w:99, h:45,l:'Room 202'},
  Kitchen2:      {x:1314,y:655,w:85, h:45,l:'Kitchen'},
  Wash2:         {x:1465,y:655,w:117,h:45,l:'Washroom 2'},
  Stair2:        {x:1621,y:655,w:95, h:45,l:'Stairs F2'},
  Server:        {x:1778,y:655,w:120,h:45,l:'Server Room'},
  Lobby3:        {x:468, y:655,w:86, h:45,l:'Lobby 3'},
  R301:          {x:92,  y:775,w:99, h:45,l:'Room 301'},
  R302:          {x:240, y:775,w:99, h:45,l:'Room 302'},
  R303:          {x:389, y:775,w:99, h:45,l:'Room 303'},
  Wash3:         {x:547, y:775,w:117,h:45,l:'Washroom 3'},
  Stair3:        {x:702, y:775,w:95, h:45,l:'Stairs F3'},
  Balcony3:      {x:842, y:775,w:86, h:45,l:'Balcony'},
};

const FLOORS_SVG = [
  {id:'b1',l:'Basement (B1)',x:90,  y:318,w:747,h:240},
  {id:'gf',l:'Ground Floor', x:872, y:8,  w:891,h:405},
  {id:'f1',l:'Floor 1',      x:1893,y:318,w:888,h:240},
  {id:'f2',l:'Floor 2',      x:940, y:463,w:933,h:240},
  {id:'f3',l:'Floor 3',      x:8,   y:608,w:913,h:215},
];

const EDGES_LIST = [
  ['StairG','Stair1','cross'],['Stair1','Stair2','cross'],['Stair2','Stair3','cross'],['StairG','StairB','cross'],
  ['Entrance','Reception'],['Reception','Hall'],
  ['Hall','Control'],['Hall','KitchenG'],['Hall','WashG'],['Hall','StairG'],['Hall','ExitA'],['Hall','ExitB'],
  ['Parking','Electrical'],['Parking','Generator'],['Parking','StairB'],['Parking','EmergencyExit'],
  ['Lobby1','R101'],['Lobby1','R102'],['Lobby1','Office'],['Lobby1','Wash1'],['Lobby1','Storage'],['Lobby1','Stair1'],
  ['Lobby2','R201'],['Lobby2','R202'],['Lobby2','Kitchen2'],['Lobby2','Wash2'],['Lobby2','Server'],['Lobby2','Stair2'],
  ['Lobby3','R301'],['Lobby3','R302'],['Lobby3','R303'],['Lobby3','Wash3'],['Lobby3','Stair3'],['Lobby3','Balcony3'],
];

function isPathEdge(a,b){ if(!state.currentPath) return false; const p=state.currentPath; for(let i=0;i<p.length-1;i++){ if((p[i]===a&&p[i+1]===b)||(p[i]===b&&p[i+1]===a)) return true; } return false; }
function nodeStatus(id){ if(id===START_NODE) return 'start'; if(EXITS.has(id)&&state.hazardNodes.has(id)) return 'exit-blocked'; if(EXITS.has(id)) return 'exit'; if(state.hazardNodes.has(id)) return 'hazard'; if(state.currentPath?.includes(id)) return 'path'; if(NODES[id]?.type==='stair') return 'stair'; return 'normal'; }
function hEmoji(t){ return {fire:'ğŸ”¥',smoke:'ğŸ’¨',closed:'ğŸ”’',exit_blocked:'ğŸš«'}[t]||'âš '; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER SVG MAP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SVG_SCALE = 0.5;
const SVG_PAD   = 24;
const SVG_VW    = 2788.5 + SVG_PAD * 2;
const SVG_VH    = 831    + SVG_PAD * 2;

function renderMap(){
  let s = `<svg id="building-svg"
    viewBox="${-SVG_PAD} ${-SVG_PAD} ${SVG_VW} ${SVG_VH}"
    width="${SVG_VW * SVG_SCALE}"
    height="${SVG_VH * SVG_SCALE}"
    xmlns="http://www.w3.org/2000/svg" style="display:block;user-select:none">`;

  /* â”€â”€ floor clusters â”€â”€ */
  FLOORS_SVG.forEach(f => {
    const isZoomed = state.zoomedFloor === f.id;
    // background rect
    s += `<rect class="floor-rect ${f.id}" x="${f.x}" y="${f.y}" width="${f.w}" height="${f.h}" rx="10"/>`;
    // zoom ring when active
    if(isZoomed){
      s += `<rect class="floor-zoom-ring" x="${f.x-4}" y="${f.y-4}" width="${f.w+8}" height="${f.h+8}" rx="13"/>`;
    }
    // transparent hit zone for the whole floor (dblclick)
    s += `<rect class="floor-hit" x="${f.x}" y="${f.y}" width="${f.w}" height="${f.h}" rx="10"
      ondblclick="handleFloorDblClick(event,'${f.id}')"
      style="cursor:${isZoomed?'zoom-out':'zoom-in'}"/>`;
    // label
    s += `<text class="floor-label" x="${f.x + f.w/2}" y="${f.y + 20}" text-anchor="middle">${f.l}</text>`;
  });

  /* â”€â”€ edges â”€â”€ */
  EDGES_LIST.forEach(([a,b,t]) => {
    if(!ND[a]||!ND[b]) return;
    const onP = isPathEdge(a,b);
    s += `<line class="edge${t==='cross'?' cross':''} ${onP?'on-path':''}"
      x1="${ND[a].x}" y1="${ND[a].y}" x2="${ND[b].x}" y2="${ND[b].y}"/>`;
  });

  /* â”€â”€ nodes â”€â”€ */
  Object.entries(ND).forEach(([id,nd]) => {
    const st  = nodeStatus(id);
    const ht  = state.hazardTypes[id];
    const pi  = state.currentPath ? state.currentPath.indexOf(id) : -1;
    const isS = id === START_NODE;
    const isE = EXITS.has(id);
    const {x:cx, y:cy, w, h} = nd;

    s += `<g class="node-g s-${st}" data-id="${id}" onclick="toggleHazard('${id}')">`;
    s += `<rect class="node-rect" x="${cx-w/2}" y="${cy-h/2}" width="${w}" height="${h}" rx="5"/>`;
    s += `<text class="node-lbl" x="${cx}" y="${cy+1}">${nd.l}</text>`;
    if(isS){ s += `<rect class="badge-bg-start" x="${cx-20}" y="${cy-h/2-11}" width="40" height="13" rx="2"/><text class="badge-txt" x="${cx}" y="${cy-h/2-4.5}">START</text>`; }
    if(isE&&!ht){ s += `<rect class="badge-bg-exit" x="${cx-16}" y="${cy-h/2-11}" width="32" height="13" rx="2"/><text class="badge-txt" x="${cx}" y="${cy-h/2-4.5}">EXIT</text>`; }
    if(ht){ s += `<text class="haz-emoji" x="${cx+w/2-14}" y="${cy+1}">${hEmoji(ht)}</text>`; }
    if(pi>=0){ s += `<circle class="step-c" cx="${cx-w/2+11}" cy="${cy+h/2-11}" r="9"/><text class="step-n" x="${cx-w/2+11}" y="${cy+h/2-11}">${pi+1}</text>`; }
    s += `</g>`;
  });

  s += `</svg>`;
  document.getElementById('svg-pan-wrap').innerHTML = s;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FLOOR DOUBLE-CLICK ZOOM
   - Works by CSS transform on #svg-pan-wrap
   - translate so the clicked floor becomes the
     visual centre of #map-scroll
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleFloorDblClick(evt, floorId){
  evt.stopPropagation();

  // Zoom OUT if already zoomed into this floor
  if(state.zoomedFloor === floorId){
    zoomOut();
    return;
  }

  // Find floor data
  const f = FLOORS_SVG.find(x => x.id === floorId);
  if(!f) return;

  state.zoomedFloor = floorId;
  renderMap(); // refresh to show active ring

  const scroll   = document.getElementById('map-scroll');
  const wrap     = document.getElementById('svg-pan-wrap');
  const scrollW  = scroll.clientWidth;
  const scrollH  = scroll.clientHeight;

  // Floor centre in SVG coords â†’ pixel coords (at SVG_SCALE)
  const floorCx_px = (f.x + f.w/2 + SVG_PAD) * SVG_SCALE;
  const floorCy_px = (f.y + f.h/2 + SVG_PAD) * SVG_SCALE;
  const floorW_px  = f.w * SVG_SCALE;
  const floorH_px  = f.h * SVG_SCALE;

  // Compute zoom so the floor fills ~80% of the viewport
  const targetFill = 0.80;
  const zoomX = (scrollW * targetFill) / floorW_px;
  const zoomY = (scrollH * targetFill) / floorH_px;
  const zoom  = Math.min(zoomX, zoomY, 3.8); // cap so it's not ridiculous

  // Translate: after scaling around origin, we want floorCentre â†’ scrollCentre
  // transform = scale(zoom) then translate so the floor centre lands at viewport centre
  // In CSS: transform-origin is top-left (0 0)
  //   final_x = floorCx_px * zoom + tx = scrollW/2  â†’ tx = scrollW/2 - floorCx_px*zoom
  //   final_y = floorCy_px * zoom + ty = scrollH/2  â†’ ty = scrollH/2 - floorCy_px*zoom
  const tx = scrollW/2 - floorCx_px * zoom;
  const ty = scrollH/2 - floorCy_px * zoom;

  wrap.style.transformOrigin = '0 0';
  wrap.style.transform = `translate(${tx}px, ${ty}px) scale(${zoom})`;

  // Update zoom info text
  const floorNames = {b1:'Basement (B1)', gf:'Ground Floor', f1:'Floor 1', f2:'Floor 2', f3:'Floor 3'};
  document.getElementById('zoom-info').textContent = `ğŸ” ${floorNames[floorId]} â€” double-click floor to zoom out`;

  showToast(`Zoomed: ${floorNames[floorId]}`, 'info');
}

function zoomOut(){
  state.zoomedFloor = null;
  const wrap = document.getElementById('svg-pan-wrap');
  wrap.style.transformOrigin = '0 0';
  wrap.style.transform = 'translate(0px,0px) scale(1)';
  document.getElementById('zoom-info').textContent = 'Overview';
  renderMap();
  showToast('Zoom reset','info');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR TOGGLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleSidebar(){
  const app = document.getElementById('app');
  const sb  = document.getElementById('sidebar');
  const btn = document.getElementById('btn-sb-toggle');
  state.sidebarOpen = !state.sidebarOpen;
  if(state.sidebarOpen){
    sb.classList.remove('closed');
    app.classList.remove('sb-closed');
    btn.classList.add('open');
  } else {
    sb.classList.add('closed');
    app.classList.add('sb-closed');
    btn.classList.remove('open');
  }
  // Re-apply zoom after sidebar resize (layout shift)
  if(state.zoomedFloor){
    setTimeout(()=>{ handleFloorDblClick({stopPropagation:()=>{}}, state.zoomedFloor); }, 380);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATED BACKGROUND CANVAS
   Colours: site palette â€” deep navy + cyan/green particles
   Effects: drifting orbs, scan lines, grid, hex pattern
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initBgCanvas(){
  const canvas = document.getElementById('bg-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');

  let W, H;
  const particles = [];
  const HEX_COLS = 18, HEX_ROWS = 12;
  const hexes = [];
  let scanY1 = 0, scanY2 = 300, frameN = 0;

  function resize(){
    W = canvas.offsetWidth; H = canvas.offsetHeight;
    canvas.width = W; canvas.height = H;
    rebuildHexes();
  }

  function rebuildHexes(){
    hexes.length = 0;
    const r = W / HEX_COLS / 1.8;
    for(let row=0; row<HEX_ROWS+2; row++){
      for(let col=0; col<HEX_COLS+2; col++){
        const x = col * r * 1.73 + (row%2) * r * 0.87;
        const y = row * r * 1.5;
        hexes.push({ x, y, r, phase: Math.random()*Math.PI*2, speed: 0.004+Math.random()*0.008 });
      }
    }
  }

  function buildParticles(){
    particles.length = 0;
    const count = 60;
    for(let i=0;i<count;i++){
      const isCyan = Math.random() > 0.45;
      particles.push({
        x: Math.random()*W, y: Math.random()*H,
        r: Math.random()*1.5+0.3,
        vx: (Math.random()-.5)*.25, vy: (Math.random()-.5)*.2,
        alpha: Math.random()*.45+.05,
        phase: Math.random()*Math.PI*2,
        speed: .007+Math.random()*.01,
        // cyan = [0,212,255], green=[0,255,136]
        rgb: isCyan ? '0,212,255' : '0,255,136',
      });
    }
  }

  function hexPath(ctx, x, y, r){
    ctx.beginPath();
    for(let i=0;i<6;i++){
      const a = Math.PI/3*i - Math.PI/6;
      i===0 ? ctx.moveTo(x+r*Math.cos(a), y+r*Math.sin(a))
             : ctx.lineTo(x+r*Math.cos(a), y+r*Math.sin(a));
    }
    ctx.closePath();
  }

  function draw(){
    frameN++;
    ctx.clearRect(0,0,W,H);

    /* â”€ Base gradient â”€ */
    const bg = ctx.createRadialGradient(W*.45, H*.35, 0, W*.5, H*.5, Math.max(W,H)*.85);
    bg.addColorStop(0, 'rgba(4,14,40,1)');
    bg.addColorStop(.55,'rgba(6,8,15,1)');
    bg.addColorStop(1,  'rgba(2,4,10,1)');
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);

    /* â”€ Hex grid â”€ */
    hexes.forEach(h => {
      h.phase += h.speed;
      const glow = 0.5 + 0.5 * Math.sin(h.phase);
      const alpha = 0.018 + glow * 0.032;
      ctx.strokeStyle = `rgba(0,212,255,${alpha})`;
      ctx.lineWidth = 0.7;
      hexPath(ctx, h.x, h.y, h.r * .85);
      ctx.stroke();
      // rare hex inner glow
      if(glow > .92){
        ctx.fillStyle = `rgba(0,255,136,${(glow-.92)*0.06})`;
        hexPath(ctx, h.x, h.y, h.r * .85);
        ctx.fill();
      }
    });

    /* â”€ Fine dot grid â”€ */
    const GRID = 50;
    ctx.fillStyle = 'rgba(0,180,220,0.09)';
    for(let x=0; x<W; x+=GRID)
      for(let y=0; y<H; y+=GRID){
        ctx.beginPath(); ctx.arc(x,y,1,0,Math.PI*2); ctx.fill();
      }

    /* â”€ Moving scan lines â”€ */
    scanY1 = (scanY1 + 0.55) % (H + 60);
    scanY2 = (scanY2 + 0.28) % (H + 60);
    [[scanY1,'rgba(0,212,255,0.055)',40],[scanY2,'rgba(0,255,136,0.035)',25]].forEach(([y,col,h])=>{
      const g = ctx.createLinearGradient(0,y-h,0,y+h);
      g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(.5,col); g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle = g; ctx.fillRect(0, y-h, W, h*2);
    });

    /* â”€ Particles â”€ */
    particles.forEach(p => {
      p.phase += p.speed;
      p.x += p.vx; p.y += p.vy;
      if(p.x < -10) p.x = W+10;
      if(p.x > W+10) p.x = -10;
      if(p.y < -10) p.y = H+10;
      if(p.y > H+10) p.y = -10;
      const a = p.alpha * (0.4 + 0.6*Math.sin(p.phase));
      const g = ctx.createRadialGradient(p.x,p.y,0, p.x,p.y, p.r*4);
      g.addColorStop(0, `rgba(${p.rgb},${a})`);
      g.addColorStop(1, `rgba(${p.rgb},0)`);
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(p.x, p.y, p.r*4, 0, Math.PI*2); ctx.fill();
    });

    /* â”€ Ambient corner glow (cyan bottom-left, green top-right) â”€ */
    const gl1 = ctx.createRadialGradient(0,H,0, 0,H, H*.55);
    gl1.addColorStop(0,'rgba(0,212,255,0.06)'); gl1.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=gl1; ctx.fillRect(0,0,W,H);

    const gl2 = ctx.createRadialGradient(W,0,0, W,0, H*.5);
    gl2.addColorStop(0,'rgba(0,255,136,0.05)'); gl2.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle=gl2; ctx.fillRect(0,0,W,H);

    /* â”€ Vignette â”€ */
    const vig = ctx.createRadialGradient(W/2,H/2,H*.25, W/2,H/2,H*.85);
    vig.addColorStop(0,'rgba(0,0,0,0)'); vig.addColorStop(1,'rgba(0,0,0,0.45)');
    ctx.fillStyle=vig; ctx.fillRect(0,0,W,H);

    requestAnimationFrame(draw);
  }

  buildParticles();
  resize();
  window.addEventListener('resize', ()=>{ resize(); buildParticles(); });
  draw();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderRoutePanel(){
  const el = document.getElementById('route-pane'); if(!el) return;
  if(state.evacuationFailed){
    el.innerHTML=`<div class="r-fail"><div class="r-fail-icon">â˜ </div><div class="r-fail-title">EVACUATION FAILED</div><div class="r-fail-sub">No safe exit from Control Room.<br>All routes are blocked.</div><button class="btn-sm btn-danger" style="margin-top:8px" onclick="resetAll()">ğŸ”„ Clear Hazards</button></div>`;
    setStatus('EVACUATION FAILED','danger'); return;
  }
  if(!state.currentPath){
    el.innerHTML=`<div class="r-idle"><div class="r-idle-icon">ğŸ›¡</div><p>Building clear.</p><p class="r-idle-sub">Click any room to simulate a hazard.</p></div>`;
    setStatus('SYSTEM READY','clear'); return;
  }
  const p=state.currentPath, exitId=p[p.length-1], exitLabel=NODES[exitId]?.label||exitId, hops=p.length-1;
  const steps=p.map((id,i)=>{
    const nd=NODES[id]; const isLast=i===p.length-1;
    const icon=id===START_NODE?'ğŸ¯':EXITS.has(id)?'ğŸšª':NODES[id]?.type==='stair'?'ğŸªœ':'â†’';
    return `<div class="r-step${isLast?' r-step-exit':''}" style="animation-delay:${i*.06}s">
      <span class="r-step-icon">${icon}</span><span class="r-step-label">${nd?.label||id}</span>
      <span class="r-step-floor">${FLOORS[nd?.floor]?.label||''}</span>
      ${!isLast?'<div class="r-step-connector"></div>':''}
    </div>`;
  }).join('');
  const alts=findAlts(3); let altH='';
  if(alts.length>1){
    altH=`<div class="alt-block"><div class="alt-title">Alternative Routes</div>${alts.slice(1).map((alt,i)=>{
      const ae=NODES[alt[alt.length-1]]?.label||alt[alt.length-1];
      return `<div class="alt-row"><span class="alt-n">${i+2}</span><span class="alt-path">${alt.map(id=>NODES[id]?.label||id).join(' â†’ ')}</span><span class="alt-exit">â†’${ae}</span></div>`;
    }).join('')}</div>`;
  }
  el.innerHTML=`<div><div class="r-badge">âœ“ ROUTE FOUND</div><div class="r-meta">${hops} step${hops!==1?'s':''} â†’ <strong>${exitLabel}</strong></div><div class="r-steps">${steps}</div>${altH}</div>`;
  setStatus('EVACUATE â†’ '+exitLabel, 'safe');
}

function setStatus(m,c){ const el=document.getElementById('status-text'); if(!el) return; el.textContent=m; el.className='stxt '+c; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NODE LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderNodeList(){
  const el=document.getElementById('node-list'); if(!el) return;
  const fo=['GF','F1','F2','F3','B1']; let h='';
  for(const f of fo){
    const ns=Object.entries(NODES).filter(([,n])=>n.floor===f);
    if(!ns.length) continue;
    h+=`<div class="nl-floor">${FLOORS[f].label}</div>`;
    for(const [id,nd] of ns){
      const hz=state.hazardNodes.has(id);
      const iE=EXITS.has(id), iS=id===START_NODE;
      const ic=iS?'ğŸ¯':iE?'ğŸšª':nd.type==='stair'?'ğŸªœ':nd.type==='corridor'?'ğŸ›¤':'ğŸ¢';
      h+=`<div class="nl-item ${hz?'haz':''} ${iE?'exit-node':''} ${iS?'start-node':''}" onclick="toggleHazard('${id}')">
        <span class="nl-icon">${ic}</span><span class="nl-name">${nd.label}</span>
        ${hz?`<span class="nl-hbadge">${hEmoji(state.hazardTypes[id])}</span>`:''}
      </div>`;
    }
  }
  el.innerHTML=h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startTimer(){ if(state.timerRunning) return; state.timerRunning=true; state.timerInterval=setInterval(()=>{state.timerSeconds++;updateTimer();},1000); document.getElementById('btn-timer').textContent='â¸ Pause'; }
function stopTimer(){ clearInterval(state.timerInterval); state.timerRunning=false; const b=document.getElementById('btn-timer'); if(b) b.textContent='â–¶ Start'; }
function toggleTimer(){ state.timerRunning?stopTimer():startTimer(); }
function resetTimer(){ stopTimer(); state.timerSeconds=0; updateTimer(); }
function updateTimer(){ const m=String(Math.floor(state.timerSeconds/60)).padStart(2,'0'),s=String(state.timerSeconds%60).padStart(2,'0'); const el=document.getElementById('timer-val'); if(!el) return; el.textContent=`${m}:${s}`; el.className='timer-val'+(state.timerSeconds>=300?' crit':state.timerSeconds>=120?' warn':''); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIT / TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function logAudit(msg,type='info'){ const el=document.getElementById('audit-log'); if(!el) return; const t=new Date().toLocaleTimeString(); const d=document.createElement('div'); d.className='alog '+type; d.innerHTML=`<span class="alog-t">${t}</span><span class="alog-m">${msg}</span>`; el.prepend(d); while(el.children.length>60) el.removeChild(el.lastChild); }
function showToast(msg,type='info'){ const c=document.getElementById('toasts'); if(!c) return; const d=document.createElement('div'); d.className='toast '+type; d.textContent=msg; c.appendChild(d); setTimeout(()=>d.classList.add('show'),10); setTimeout(()=>{d.classList.remove('show');setTimeout(()=>d.remove(),300);},3000); }
function switchTab(id,btn){ document.querySelectorAll('.pane').forEach(p=>p.classList.remove('on')); document.querySelectorAll('.tab').forEach(b=>b.classList.remove('on')); document.getElementById('pane-'+id).classList.add('on'); btn.classList.add('on'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initBuilder(){ state.builder={nodes:{},edges:[],linkSource:null}; renderBuilder(); }
function renderBuilder(){
  const svg=document.getElementById('bcanvas'); const r=svg.getBoundingClientRect(); const W=r.width||800,H=r.height||500;
  let o=`<defs><pattern id="bg" width="40" height="40" patternUnits="userSpaceOnUse"><path d="M40 0L0 0 0 40" fill="none" stroke="rgba(0,255,136,.06)" stroke-width="1"/></pattern></defs><rect width="${W}" height="${H}" fill="url(#bg)"/>`;
  for(const [a,b] of state.builder.edges){ const na=state.builder.nodes[a],nb=state.builder.nodes[b]; if(!na||!nb) continue; o+=`<line x1="${na.x}" y1="${na.y}" x2="${nb.x}" y2="${nb.y}" stroke="rgba(0,255,136,.45)" stroke-width="2" stroke-dasharray="6,3"/>`; }
  for(const [id,nd] of Object.entries(state.builder.nodes)){
    const iS=state.builder.linkSource===id;
    o+=`<g class="b-node" data-id="${id}" style="cursor:pointer"><circle cx="${nd.x}" cy="${nd.y}" r="26" fill="${iS?'rgba(255,200,0,.25)':'rgba(17,24,39,.9)'}" stroke="${iS?'#ffc800':'rgba(0,212,255,.4)'}" stroke-width="${iS?2.5:1.5}"/><text x="${nd.x}" y="${nd.y-5}" text-anchor="middle" fill="#c8ddf0" font-size="9" font-family="Space Mono">${nd.label}</text><text x="${nd.x}" y="${nd.y+8}" text-anchor="middle" fill="rgba(0,255,136,.6)" font-size="8" font-family="Space Mono">${nd.type}</text></g>`;
  }
  svg.innerHTML=o;
  svg.querySelectorAll('.b-node').forEach(el=>{ el.addEventListener('click',e=>{ e.stopPropagation(); onBNodeClick(el.dataset.id); }); });
  runBuilderBFS();
}
function onBCanvasClick(e){ if(e.target.closest('.b-node')) return; const mode=document.getElementById('b-mode').value; if(mode!=='add') return; const r=e.currentTarget.getBoundingClientRect(); const x=e.clientX-r.left,y=e.clientY-r.top; const label=document.getElementById('b-label').value.trim()||'Node'+(Object.keys(state.builder.nodes).length+1); const type=document.getElementById('b-type').value; const id='B_'+Date.now(); state.builder.nodes[id]={label,type,x,y}; document.getElementById('b-label').value=''; renderBuilder(); }
function onBNodeClick(id){ const mode=document.getElementById('b-mode').value; if(mode==='link'){ if(!state.builder.linkSource){ state.builder.linkSource=id; showToast('Click another node to link','info'); } else if(state.builder.linkSource!==id){ const a=state.builder.linkSource; const ex=state.builder.edges.some(([x,y])=>(x===a&&y===id)||(x===id&&y===a)); if(!ex){ state.builder.edges.push([a,id]); showToast('Linked!','ok'); } state.builder.linkSource=null; } } else if(mode==='del'){ delete state.builder.nodes[id]; state.builder.edges=state.builder.edges.filter(([a,b])=>a!==id&&b!==id); state.builder.linkSource=null; } else { state.builder.linkSource=state.builder.linkSource===id?null:id; } renderBuilder(); }
function runBuilderBFS(){ const{nodes,edges}=state.builder; const ids=Object.keys(nodes); const adj={}; ids.forEach(id=>adj[id]=[]); edges.forEach(([a,b])=>{ if(adj[a])adj[a].push(b); if(adj[b])adj[b].push(a); }); const starts=ids.filter(id=>nodes[id].type==='control'); const exits=new Set(ids.filter(id=>nodes[id].type==='exit')); const res=document.getElementById('b-result'); if(!res) return; if(!starts.length||!exits.size){ res.innerHTML='<span class="b-hint">Add a Control (start) and Exit node.</span>'; return; } const p=bfs(adj,exits,starts[0],new Set(),new Set()); res.innerHTML=p?`<span class="b-ok">âœ“ ${p.map(id=>nodes[id]?.label||id).join(' â†’ ')}</span>`:`<span class="b-fail">âœ— No path found</span>`; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init(){
  try{
    document.getElementById('hazard-type').addEventListener('change', e=>state.selectedHazard=e.target.value);
    document.querySelectorAll('[data-preset]').forEach(btn=>btn.addEventListener('click',()=>applyPreset(btn.dataset.preset)));
    document.getElementById('btn-timer').addEventListener('click', toggleTimer);
    document.getElementById('btn-timer-r').addEventListener('click', resetTimer);
    document.getElementById('btn-sb-toggle').addEventListener('click', toggleSidebar);

    document.getElementById('btn-builder-open').addEventListener('click',()=>{
      document.getElementById('builder-modal').classList.add('on');
      setTimeout(()=>{ initBuilder(); document.getElementById('bcanvas').addEventListener('click', onBCanvasClick); }, 50);
    });
    document.getElementById('btn-builder-close').addEventListener('click',()=>document.getElementById('builder-modal').classList.remove('on'));
    document.getElementById('b-mode').addEventListener('change',()=>{ state.builder.linkSource=null; renderBuilder(); });

    // Double-click on the map-scroll background â†’ zoom out
    document.getElementById('map-scroll').addEventListener('dblclick', e=>{
      if(e.target.id==='map-scroll'||e.target.id==='svg-pan-wrap'||e.target.id==='building-svg'){
        if(state.zoomedFloor) zoomOut();
      }
    });

    _recalc(); renderMap(); renderNodeList(); updateTimer();
    initBgCanvas();

    logAudit('ğŸŸ¢ System initialised â€” Control Room is start point','ok');
    logAudit('â„¹ Click any room to toggle hazard Â· Double-click floor to zoom','info');

  }catch(err){ console.error('Init error:',err); }
  finally{
    setTimeout(()=>{
      document.getElementById('loading').classList.add('gone');
      document.getElementById('app').classList.add('on');
    }, 1300);
  }
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
